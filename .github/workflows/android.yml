name: Sync Upstream & Build Android Binaries (CGO=0 & CGO=1)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    tags:
      - 'v*-android*'

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with Upstream
        run: |
          git remote add upstream https://github.com/sipeed/picoclaw.git || true
          git fetch upstream
          git checkout main
          git merge upstream/main --allow-unrelated-histories --no-edit || echo "Merge conflict? Resolve manually if needed."
          git push origin main || echo "Push skipped if no changes"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Go Mod Tidy & Download
        run: |
          go mod tidy
          go mod download

      # ============ PATCH SOURCE FOR ANDROID BUILD ============
      - name: Patch main.go for Android Build
        run: |
          cd cmd/picoclaw
          
          # Create workspace_embed.go with full embed logic for non-Android builds
          cat > workspace_embed.go << 'EOF'
          //go:build !android
          // +build !android

          package main

          import "embed"

          //go:generate cp -r ../../workspace .
          //go:embed workspace
          var embeddedFiles embed.FS

          const hasEmbeddedWorkspace = true
          EOF
          
          # Create workspace_stub.go for Android builds (no embedding)
          cat > workspace_stub.go << 'EOF'
          //go:build android
          // +build android

          package main

          import "embed"

          // Empty embed.FS for Android builds (workspace not embedded)
          var embeddedFiles embed.FS

          const hasEmbeddedWorkspace = false
          EOF
          
          # Remove embed-related lines from main.go since they're now in workspace_embed.go
          sed -i '/^\/\/go:generate cp -r \.\.\/\.\.\/workspace \.$/d' main.go
          sed -i '/^\/\/go:embed workspace$/d' main.go
          sed -i '/^var embeddedFiles embed\.FS$/d' main.go
          
          # Remove standalone "embed" import if it exists (it's now in workspace_*.go)
          # This handles the case where embed is imported but not used after removing embeddedFiles
          sed -i '/"embed"$/d' main.go
          
          # Also handle case where embed might be in import block
          awk '
          BEGIN { in_import = 0; skip_next_close = 0 }
          /^import \(/ { in_import = 1; print; next }
          in_import && /^\)/ { 
            in_import = 0
            if (!skip_next_close) print
            skip_next_close = 0
            next
          }
          in_import && /^\t"embed"$/ { 
            skip_next_close = 0
            next 
          }
          { print }
          ' main.go > main.go.tmp && mv main.go.tmp main.go
          
          # Add hasEmbeddedWorkspace check at the beginning of copyEmbeddedToTarget
          awk '
          /^func copyEmbeddedToTarget\(targetDir string\) error \{/ {
            print $0
            print "\t// Skip embedding for Android builds"
            print "\tif !hasEmbeddedWorkspace {"
            print "\t\treturn os.MkdirAll(targetDir, 0755)"
            print "\t}"
            print ""
            next
          }
          { print }
          ' main.go > main.go.tmp && mv main.go.tmp main.go
          
          echo "‚úÖ Source patched for Android build"
          echo ""
          echo "üìÅ Created build-tag files:"
          ls -la workspace_*.go
          echo ""
          echo "üîç Verification - embed removed from main.go:"
          grep -c "embed" main.go || echo "No embed references in main.go (‚úì)"
          echo ""
          echo "üîç Verification - embeddedFiles in workspace files:"
          grep "embeddedFiles" workspace_*.go

      # Build CGO=0 with android tag
      - name: Build Android arm64 - CGO=0
        run: |
          cd cmd/picoclaw
          GOOS=android GOARCH=arm64 CGO_ENABLED=0 \
            go build -v -trimpath -tags=android -ldflags="-s -w" \
            -o ../../picoclaw-no-cgo

      # Setup NDK for CGO=1
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r27d

      - name: Build Android arm64 - CGO=1
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CC: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang
          CXX: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang++
        run: |
          cd cmd/picoclaw
          CGO_ENABLED=1 GOOS=android GOARCH=arm64 \
            go build -v -trimpath -tags=android -ldflags="-s -w" \
            -o ../../picoclaw-cgo

      - name: Verify Binaries
        run: |
          file picoclaw-no-cgo || true
          file picoclaw-cgo || true
          ls -lh picoclaw-*
          echo ""
          echo "üìä Build Results:"
          echo "  CGO=0 size: $(du -h picoclaw-no-cgo | cut -f1)"
          echo "  CGO=1 size: $(du -h picoclaw-cgo | cut -f1)"
          echo ""
          echo "‚úÖ Both Android binaries built successfully without workspace embedding"

      # Upload Artifacts (for manual/schedule runs)
      - name: Upload Artifacts (Test Builds)
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: android-binaries-${{ github.run_number }}
          path: |
            picoclaw-no-cgo
            picoclaw-cgo
          retention-days: 14

      # Create Release ONLY when pushing tags
      - name: Create GitHub Release with Binaries
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: PicoClaw ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            picoclaw-no-cgo
            picoclaw-cgo