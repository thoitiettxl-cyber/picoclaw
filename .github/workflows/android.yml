name: Sync Upstream & Build Android Binaries (CGO=0 & CGO=1)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    tags:
      - 'v*-android*'

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with Upstream
        run: |
          git remote add upstream https://github.com/sipeed/picoclaw.git || true
          git fetch upstream
          git checkout main
          git merge upstream/main --allow-unrelated-histories --no-edit || echo "Merge conflict? Resolve manually if needed."
          git push origin main || echo "Push skipped if no changes"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Go Mod Tidy & Download
        run: |
          go mod tidy
          go mod download

      # ============ PATCH SOURCE FOR ANDROID BUILD ============
      - name: Patch main.go for Android Build
        run: |
          cd cmd/picoclaw
          
          # Backup original file
          cp main.go main.go.backup
          
          # Create workspace_stub.go for Android
          cat > workspace_stub.go << 'EOF'
          //go:build android
          // +build android
          
          package main
          
          import "embed"
          
          // Empty embed.FS for Android builds (no workspace embedding)
          var embeddedFiles embed.FS
          
          const hasEmbeddedWorkspace = false
          EOF
          
          # Create workspace_embed.go with original embed logic
          cat > workspace_embed.go << 'EOF'
          //go:build !android
          // +build !android
          
          package main
          
          import "embed"
          
          //go:generate cp -r ../../workspace .
          //go:embed workspace
          var embeddedFiles embed.FS
          
          const hasEmbeddedWorkspace = true
          EOF
          
          # Patch main.go - remove embed directives and add hasEmbeddedWorkspace constant
          sed -i '/^\/\/go:generate cp -r \.\.\/\.\.\/workspace \./d' main.go
          sed -i '/^\/\/go:embed workspace$/d' main.go
          sed -i 's/^var embeddedFiles embed\.FS$/\/\/ embeddedFiles is defined in workspace_embed.go or workspace_stub.go based on build tags/' main.go
          
          # Add hasEmbeddedWorkspace check in copyEmbeddedToTarget function
          # Find the function and add early return for Android
          awk '
          /^func copyEmbeddedToTarget\(targetDir string\) error \{/ {
            print $0
            print "\tif !hasEmbeddedWorkspace {"
            print "\t\t// Android build - no embedded workspace"
            print "\t\treturn os.MkdirAll(targetDir, 0755)"
            print "\t}"
            print ""
            next
          }
          { print }
          ' main.go > main.go.tmp && mv main.go.tmp main.go
          
          echo "âœ… Source patched for Android build"
          echo ""
          echo "Created files:"
          ls -la workspace_*.go
          echo ""
          echo "Modified main.go (showing embed section):"
          grep -A 5 -B 5 "embeddedFiles" main.go || echo "Embed directives removed"

      # Build CGO=0 with android tag
      - name: Build Android arm64 - CGO=0
        run: |
          cd cmd/picoclaw
          GOOS=android GOARCH=arm64 CGO_ENABLED=0 \
            go build -v -trimpath -tags=android -ldflags="-s -w" \
            -o ../../picoclaw-no-cgo

      # Setup NDK for CGO=1
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r27d

      - name: Build Android arm64 - CGO=1
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CC: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang
          CXX: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang++
        run: |
          cd cmd/picoclaw
          CGO_ENABLED=1 GOOS=android GOARCH=arm64 \
            go build -v -trimpath -tags=android -ldflags="-s -w" \
            -o ../../picoclaw-cgo

      - name: Verify Binaries
        run: |
          file picoclaw-no-cgo || true
          file picoclaw-cgo || true
          ls -lh picoclaw-*
          echo ""
          echo "ðŸ“Š Build Results:"
          echo "  CGO=0 size: $(du -h picoclaw-no-cgo | cut -f1)"
          echo "  CGO=1 size: $(du -h picoclaw-cgo | cut -f1)"
          echo ""
          echo "Binary info:"
          echo "  no-cgo: $(file picoclaw-no-cgo)"
          echo "  cgo: $(file picoclaw-cgo)"

      # Upload Artifacts (for manual/schedule runs)
      - name: Upload Artifacts (Test Builds)
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: android-binaries-${{ github.run_number }}
          path: |
            picoclaw-no-cgo
            picoclaw-cgo
          retention-days: 14

      # Create Release ONLY when pushing tags
      - name: Create GitHub Release with Binaries
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: PicoClaw ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            picoclaw-no-cgo
            picoclaw-cgo